<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Mockrise • Cut-off</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body{font-family:"Lexend",sans-serif;background:#f5f5f8;min-height:100dvh;}
    .shadow-card{box-shadow:0 14px 40px rgba(0,0,0,.08);}
    .field{
      width:100%;height:54px;
      border:1.5px solid #dbdbe6;border-radius:18px;
      padding:12px 14px;font-weight:800;outline:none;background:#fff;
    }
    .field:focus{
      border-color:#0a0ac2;
      box-shadow:0 0 0 4px rgba(10,10,194,.12);
    }
    .btnPrimary{
      width:100%;
      background:#0a0ac2;color:#fff;
      font-weight:900;padding:15px;border-radius:20px;
      box-shadow:0 12px 24px rgba(10,10,194,.20);
      transition:.2s;
      display:flex;align-items:center;justify-content:center;gap:10px;
      cursor:pointer; user-select:none;
    }
    .btnPrimary:active{transform:scale(.98);}
    .btnGhost{
      width:100%;
      background:#fff;color:#0a0ac2;
      font-weight:900;padding:15px;border-radius:20px;
      border:1.5px solid #dbdbe6;
      transition:.2s;
      display:flex;align-items:center;justify-content:center;gap:10px;
      cursor:pointer; user-select:none;
    }
    .btnGhost:active{transform:scale(.98);}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:rgba(10,10,194,.08);
      color:#0a0ac2;font-weight:900;font-size:12px;
      border:1px solid rgba(10,10,194,.10);
      white-space:nowrap;
    }
    .cutBox{
      background:#fff;border:1px solid #eef0f6;
      border-radius:18px;padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.05);
      display:flex;flex-direction:column;gap:6px;
    }
    .cutLabel{font-size:11px;color:#6b7280;font-weight:900;letter-spacing:.12em;text-transform:uppercase;}
    .cutValue{font-size:18px;font-weight:900;color:#111118;line-height:1.1;}
    .cutTag{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:900;color:#16a34a;}
    .line{height:1px;background:linear-gradient(90deg, transparent, rgba(10,10,194,.25), transparent);}
    .smallNote{font-size:11px;color:#6b7280;font-weight:800;line-height:1.4;}
  </style>
</head>

<body>
<div class="max-w-[1100px] mx-auto min-h-screen bg-white shadow-xl flex flex-col overflow-hidden">

  <!-- Header -->
  <div class="flex items-center bg-white p-4 border-b border-gray-100 sticky top-0 z-20">
    <button onclick="goBack()" class="text-[#0a0ac2] flex size-10 items-center justify-center cursor-pointer rounded-full hover:bg-[#0a0ac2]/10 transition">
      <span class="material-symbols-outlined">arrow_back</span>
    </button>
    <h2 class="text-[#111118] text-lg font-black flex-1 text-center">Cut-off Checker</h2>
    <div class="size-10"></div>
  </div>

  <!-- Title -->
  <div class="px-6 pt-8 pb-4">
    <h3 class="text-[#111118] text-2xl font-black text-center">Mockrise Auto Cut-off</h3>
    <p class="text-[#60608a] text-sm mt-2 text-center">
      Complete exam cut-off (overall) — Firestore से auto calculate ✅
    </p>
  </div>

  <div class="px-6 pb-10 space-y-6">

    <!-- ✅ User Details (NO LOGIN, NO PHOTO) -->
    <div class="rounded-2xl border border-[#dbdbe6] bg-white p-4 shadow-card">
      <div class="text-[#0a0ac2] text-xs font-black uppercase tracking-widest mb-3">User Details</div>

      <label class="text-xs font-black text-gray-500 uppercase tracking-widest">Full Name</label>
      <input id="uName" class="field mt-2" placeholder="Enter your name"/>

      <div class="mt-4">
        <label class="text-xs font-black text-gray-500 uppercase tracking-widest">Mobile Number</label>
        <input id="uMobile" class="field mt-2" placeholder="10 digit mobile" inputmode="numeric" maxlength="10"/>
      </div>

      <div class="mt-4">
        <label class="text-xs font-black text-gray-500 uppercase tracking-widest">Email (optional)</label>
        <input id="uEmail" class="field mt-2" placeholder="example@gmail.com" inputmode="email"/>
      </div>

      <div class="mt-4 flex flex-col gap-3">
        <button id="saveUserBtn" class="btnPrimary">
          <span class="material-symbols-outlined">save</span>
          Save Details
        </button>

        <button id="clearUserBtn" class="btnGhost">
          <span class="material-symbols-outlined">delete</span>
          Clear
        </button>
      </div>

      <div class="mt-4 line"></div>

      <div class="mt-4 flex items-center justify-between flex-wrap gap-3">
        <div class="smallNote">
          Saved Status: <span id="userSaveStatus" style="color:#111118;font-weight:900;">Not saved</span>
        </div>
        <div class="smallNote">
          Device ID: <span id="deviceIdTxt" style="color:#6b7280;font-weight:900;">-</span>
        </div>
      </div>
    </div>

    <!-- Select Exam -->
    <div class="rounded-2xl border border-[#dbdbe6] bg-white p-4 shadow-card">
      <div class="text-[#0a0ac2] text-xs font-black uppercase tracking-widest mb-3">Exam Setup</div>

      <label class="text-xs font-black text-gray-500 uppercase tracking-widest">Exam</label>
      <select id="examSelect" class="field mt-2">
        <option value="">Loading...</option>
      </select>

      <div class="mt-4 flex flex-wrap gap-2">
        <span class="chip"><span class="material-symbols-outlined text-base">groups</span><span id="formsTxt">Forms: -</span></span>
        <span class="chip"><span class="material-symbols-outlined text-base">event_seat</span><span id="vacancyTxt">Vacancy: -</span></span>
        <span class="chip"><span class="material-symbols-outlined text-base">score</span><span id="marksTxt">Total Marks: -</span></span>
        <span class="chip"><span class="material-symbols-outlined text-base">rule</span><span id="ruleTxt">+ -</span></span>
      </div>

      <div class="mt-4">
        <button id="calcBtn" class="btnPrimary">
          <span class="material-symbols-outlined">analytics</span>
          Calculate Overall Cut-off
        </button>
      </div>

      <div class="mt-4 line"></div>

      <div class="mt-4 flex items-center justify-between flex-wrap gap-3">
        <div class="smallNote">
          Last Updated: <span id="lastUpdated" style="color:#111118;font-weight:900;">-</span>
        </div>
        <div class="smallNote">
          Status: <span id="statusTxt" style="color:#16a34a;font-weight:900;">Ready</span>
        </div>
      </div>
    </div>

    <!-- Warning -->
    <div class="rounded-2xl border border-yellow-200 bg-yellow-50 p-4">
      <div class="flex items-start gap-3">
        <div class="size-10 rounded-xl bg-yellow-200/70 flex items-center justify-center text-yellow-800">
          <span class="material-symbols-outlined">warning</span>
        </div>
        <div>
          <div class="font-black text-[#111118] text-sm">Warning / Note</div>
          <p class="text-xs text-yellow-900/80 mt-1 leading-relaxed">
            यह data continuously update होता रहता है। Cut-off Firestore में saved students attempts के marks से auto calculate होती है।
          </p>
        </div>
      </div>
    </div>

    <!-- Cutoff Boxes -->
    <div class="rounded-2xl border border-[#dbdbe6] bg-white p-4 shadow-card">
      <div class="flex items-center justify-between gap-2 mb-3">
        <h3 class="text-[#111118] font-black text-base">Category-wise Cutoff (Overall Exam)</h3>
        <span class="text-xs font-black text-[#0a0ac2]" id="examTitleMini">-</span>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div class="cutBox">
          <div class="cutLabel">General</div>
          <div class="cutValue" id="coGEN">--</div>
          <div class="cutTag"><span class="material-symbols-outlined text-[16px]">check_circle</span> Auto</div>
        </div>
        <div class="cutBox">
          <div class="cutLabel">OBC</div>
          <div class="cutValue" id="coOBC">--</div>
          <div class="cutTag"><span class="material-symbols-outlined text-[16px]">check_circle</span> Auto</div>
        </div>
        <div class="cutBox">
          <div class="cutLabel">SC</div>
          <div class="cutValue" id="coSC">--</div>
          <div class="cutTag"><span class="material-symbols-outlined text-[16px]">check_circle</span> Auto</div>
        </div>
        <div class="cutBox">
          <div class="cutLabel">ST</div>
          <div class="cutValue" id="coST">--</div>
          <div class="cutTag"><span class="material-symbols-outlined text-[16px]">check_circle</span> Auto</div>
        </div>
        <div class="cutBox">
          <div class="cutLabel">EWS</div>
          <div class="cutValue" id="coEWS">--</div>
          <div class="cutTag"><span class="material-symbols-outlined text-[16px]">check_circle</span> Auto</div>
        </div>
        <div class="cutBox">
          <div class="cutLabel">Other</div>
          <div class="cutValue" id="coOTHER">--</div>
          <div class="cutTag"><span class="material-symbols-outlined text-[16px]">check_circle</span> Auto</div>
        </div>
      </div>

      <div class="mt-4 smallNote">
        *यह cut-off पूरे exam के सभी students data से calculate होती है (shift/paperCode नहीं).
      </div>
    </div>

    <!-- Telegram CTA -->
    <div class="rounded-2xl border border-[#0088cc]/20 bg-[#0088cc]/10 p-5">
      <div class="flex items-start gap-3">
        <div class="size-11 rounded-2xl bg-[#0088cc] flex items-center justify-center text-white shadow-lg">
          <span class="material-symbols-outlined">send</span>
        </div>
        <div class="flex-1">
          <div class="font-black text-[#111118] text-base">Join Mockrise Telegram</div>
          <p class="text-xs text-[#0f3a52] font-bold mt-1 leading-relaxed">
            Cut-off updates, result alerts, new exams & notifications instantly ✅
          </p>
          <button onclick="window.open('https://t.me/mockrise','_blank')" class="mt-4 w-full bg-[#0088cc] hover:bg-[#0077b5] text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 transition">
            <span>Join Telegram</span>
            <span class="material-symbols-outlined text-[20px]">open_in_new</span>
          </button>
        </div>
      </div>
    </div>

    <div class="text-center text-[11px] text-gray-400 font-bold pb-10">
      Mockrise • Auto Cut-off System
    </div>

  </div>
</div>

<!-- ✅ Firebase + Logic -->
<script type="module">
  // ✅ Blogger
  const BLOGGER_ID = "1505425628593992085";
  const BLOGGER_KEY = "AIzaSyBaGppSDvKYBc_UGMDQ2JGmKi0V2FQa2ec";
  const LABEL = "Result Name";

  // ✅ Firebase (NO AUTH USED - so no login popup)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0QINninWOOCWh9Q1gomxHC0Y1_hrzjOU",
    authDomain: "test-series-app-8295f.firebaseapp.com",
    projectId: "test-series-app-8295f",
    storageBucket: "test-series-app-8295f.firebasestorage.app",
    messagingSenderId: "576199084436",
    appId: "1:576199084436:web:875173574f2a0675a6a781"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);

  let posts = [];
  let examConfig = null;
  let selectedExamTitle = "";

  function goBack(){
    try{ window.location.href="go:back"; }
    catch(e){ history.back(); }
  }
  window.goBack = goBack;

  function setStatus(text, color="green"){
    $("statusTxt").textContent = text;
    $("statusTxt").style.color =
      color==="green" ? "#16a34a" :
      color==="red" ? "#dc2626" :
      "#f59e0b";
  }

  function setLastUpdated(){
    const d = new Date();
    const date = d.toLocaleDateString("en-GB");
    const time = d.toLocaleTimeString("en-IN", { hour:"2-digit", minute:"2-digit" });
    $("lastUpdated").textContent = `${date} • ${time}`;
  }

  function parseJSONFromHTML(html){
    const match = (html||"").match(/\{[\s\S]*\}/);
    if(!match) return null;
    try{ return JSON.parse(match[0]); } catch(e){ return null; }
  }

  // ✅ Simple device id (NO PHOTO, NO LOGIN)
  function getDeviceId(){
    let id = localStorage.getItem("mockrise_device_id");
    if(!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem("mockrise_device_id", id);
    }
    return id;
  }

  const DEVICE_ID = getDeviceId();
  $("deviceIdTxt").textContent = DEVICE_ID;

  // ✅ Load saved user fields
  function loadUserLocal(){
    const name = localStorage.getItem("mr_name") || "";
    const mobile = localStorage.getItem("mr_mobile") || "";
    const email = localStorage.getItem("mr_email") || "";
    $("uName").value = name;
    $("uMobile").value = mobile;
    $("uEmail").value = email;
  }

  function setUserSaveStatus(txt, color="#111118"){
    $("userSaveStatus").textContent = txt;
    $("userSaveStatus").style.color = color;
    $("userSaveStatus").style.fontWeight = "900";
  }

  function isValidMobile(m){
    return /^[6-9]\d{9}$/.test(String(m||"").trim());
  }

  // ✅ Save User Details to Firestore (NO AUTH REQUIRED)
  $("saveUserBtn").addEventListener("click", async ()=>{
    const name = String($("uName").value||"").trim();
    const mobile = String($("uMobile").value||"").trim();
    const email = String($("uEmail").value||"").trim();

    if(name.length < 2){
      alert("नाम सही भर ✅");
      return;
    }
    if(!isValidMobile(mobile)){
      alert("Mobile number सही डाल (10 digit) ✅");
      return;
    }

    try{
      setUserSaveStatus("Saving...", "#f59e0b");

      // local save
      localStorage.setItem("mr_name", name);
      localStorage.setItem("mr_mobile", mobile);
      localStorage.setItem("mr_email", email);

      // Firestore save (collection: users_public)
      // ✅ No photo fields added at all
      const ref = doc(db, "users_public", DEVICE_ID);

      await setDoc(ref, {
        name,
        mobile,
        email,
        deviceId: DEVICE_ID,
        updatedAt: Date.now()
      }, { merge: true });

      setUserSaveStatus("Saved ✅", "#16a34a");
    }catch(e){
      console.log(e);
      setUserSaveStatus("Failed ❌", "#dc2626");
      alert("Firestore save error ❌ (rules check कर)");
    }
  });

  $("clearUserBtn").addEventListener("click", ()=>{
    $("uName").value = "";
    $("uMobile").value = "";
    $("uEmail").value = "";
    localStorage.removeItem("mr_name");
    localStorage.removeItem("mr_mobile");
    localStorage.removeItem("mr_email");
    setUserSaveStatus("Cleared", "#111118");
  });

  async function loadExams(){
    try{
      setStatus("Loading...", "orange");
      const url =
        `https://www.googleapis.com/blogger/v3/blogs/${BLOGGER_ID}/posts`+
        `?key=${BLOGGER_KEY}`+
        `&labels=${encodeURIComponent(LABEL)}`+
        `&maxResults=15`+
        `&fields=items(title,content)`;

      const res = await fetch(url);
      const data = await res.json();
      posts = data.items || [];

      $("examSelect").innerHTML = `<option value="">Select exam</option>`;
      posts.forEach((p,i)=>{
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = p.title;
        $("examSelect").appendChild(opt);
      });

      setStatus("Ready", "green");
      setLastUpdated();
    }catch(e){
      setStatus("Failed", "red");
      $("examSelect").innerHTML = `<option value="">Failed to load</option>`;
    }
  }

  function renderMeta(cfg, title){
    $("examTitleMini").textContent = title || cfg.examName || "-";
    $("formsTxt").textContent = `Forms: ${(cfg.totalForms||"-").toLocaleString ? Number(cfg.totalForms).toLocaleString("en-IN") : (cfg.totalForms||"-")}`;
    $("vacancyTxt").textContent = `Vacancy: ${cfg.vacancy ?? "-"}`;
    $("marksTxt").textContent = `Total Marks: ${cfg.totalMarks ?? "-"}`;
    $("ruleTxt").textContent = `+${cfg.pm ?? "-"} / -${cfg.nm ?? "-"}`;
  }

  $("examSelect").addEventListener("change", ()=>{
    const idx = $("examSelect").value;
    if(idx===""){
      examConfig=null;
      return;
    }
    const post = posts[Number(idx)];
    selectedExamTitle = post.title || "";
    const json = parseJSONFromHTML(post.content || "");
    if(!json){
      alert("JSON invalid ❌");
      return;
    }
    examConfig=json;
    renderMeta(examConfig, selectedExamTitle);
    setLastUpdated();
  });

  function percentileCutoff(marksArr, topPercent){
    if(!marksArr.length) return null;
    const sorted = [...marksArr].sort((a,b)=>b-a);
    const idx = Math.max(0, Math.floor((topPercent/100) * sorted.length) - 1);
    return sorted[idx] ?? sorted[sorted.length-1];
  }

  async function fetchAllAttemptsForExam(examName){
    const qy = query(
      collection(db,"attempts"),
      where("examName","==", examName)
    );
    const snap = await getDocs(qy);
    const list=[];
    snap.forEach(d=>list.push(d.data()));
    return list;
  }

  function getCutoffForCategory(allAttempts, cat){
    const catList = allAttempts.filter(x => String(x.category||"OTHER") === cat);
    const marksArr = catList.map(x=>Number(x.marks||0)).filter(n=>!isNaN(n));
    return percentileCutoff(marksArr, 10);
  }

  function setBox(id, val, totalMarks){
    if(val===null || val===undefined){
      $(id).textContent="--";
      return;
    }
    const low = Math.max(0, Math.round(val-2));
    const high = Math.min(totalMarks, Math.round(val+2));
    $(id).textContent = `${low} - ${high}`;
  }

  $("calcBtn").addEventListener("click", async ()=>{
    if(!examConfig){ alert("पहले exam select कर ✅"); return; }

    try{
      setStatus("Calculating...", "orange");

      const examName = examConfig.examName || selectedExamTitle;
      const totalMarks = Number(examConfig.totalMarks||0);

      const attempts = await fetchAllAttemptsForExam(examName);

      if(!attempts.length){
        setStatus("No data", "red");
        alert("Firestore में इस exam का data नहीं मिला ❌");
        return;
      }

      const gen = getCutoffForCategory(attempts, "GENERAL");
      const obc = getCutoffForCategory(attempts, "OBC");
      const sc  = getCutoffForCategory(attempts, "SC");
      const st  = getCutoffForCategory(attempts, "ST");
      const ews = getCutoffForCategory(attempts, "EWS");
      const oth = getCutoffForCategory(attempts, "OTHER");

      setBox("coGEN", gen, totalMarks);
      setBox("coOBC", obc, totalMarks);
      setBox("coSC", sc, totalMarks);
      setBox("coST", st, totalMarks);
      setBox("coEWS", ews, totalMarks);
      setBox("coOTHER", oth, totalMarks);

      setLastUpdated();
      setStatus("Updated ✅", "green");

    }catch(e){
      console.log(e);
      setStatus("Failed", "red");
      alert("Firestore read error ❌ (rules check कर)");
    }
  });

  // Init
  loadUserLocal();
  loadExams();
  setLastUpdated();
</script>
</body>
</html>
